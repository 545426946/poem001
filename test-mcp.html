<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP系统测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>🔍 Supabase MCP 系统测试</h1>
    
    <div id="status">
        <h2>系统状态</h2>
        <div id="connection-status" class="test-result">检查中...</div>
        <div id="health-status" class="test-result">检查中...</div>
        <div id="init-status" class="test-result">检查中...</div>
    </div>

    <div id="actions">
        <h2>测试操作</h2>
        <button onclick="runQuickCheck()">快速检查</button>
        <button onclick="runFullCheck()">完整检查</button>
        <button onclick="testDataQuery()">测试数据查询</button>
        <button onclick="testHealthCheck()">健康检查</button>
    </div>

    <div id="results">
        <h2>测试结果</h2>
        <div id="test-results"></div>
    </div>

    <script type="module">
        // 动态导入MCP检查工具
        async function runQuickCheck() {
            try {
                const mcpChecker = await import('./src/utils/mcp-check.js');
                const result = await mcpChecker.default.quickCheck();
                updateStatus('健康检查', result.healthy ? 'success' : 'error', 
                    `健康状态: ${result.healthy ? '正常' : '异常'}, 消息: ${result.message}`);
            } catch (error) {
                updateStatus('快速检查', 'error', `检查失败: ${error.message}`);
            }
        }

        async function runFullCheck() {
            try {
                const mcpChecker = await import('./src/utils/mcp-check.js');
                const result = await mcpChecker.default.runComprehensiveCheck();
                updateStatus('完整检查', 'success', '检查完成，请查看控制台输出');
            } catch (error) {
                updateStatus('完整检查', 'error', `检查失败: ${error.message}`);
            }
        }

        async function testDataQuery() {
            try {
                const mcpService = await import('./src/services/mcpService.js');
                const poems = await mcpService.default.getPoemsData('all', 3);
                updateStatus('数据查询', 'success', 
                    `查询成功，获取到 ${poems.length} 条诗歌数据`);
                console.log('诗歌数据示例:', poems);
            } catch (error) {
                updateStatus('数据查询', 'error', `查询失败: ${error.message}`);
            }
        }

        async function testHealthCheck() {
            try {
                const mcpService = await import('./src/services/mcpService.js');
                const health = await mcpService.default.healthCheck();
                updateStatus('健康检查', health.healthy ? 'success' : 'warning', 
                    `服务状态: ${health.healthy ? '正常' : '异常'}, 消息: ${health.message}`);
            } catch (error) {
                updateStatus('健康检查', 'error', `检查失败: ${error.message}`);
            }
        }

        function updateStatus(testName, type, message) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `<strong>${testName}:</strong> ${message}`;
            resultsDiv.appendChild(resultDiv);
        }

        // 页面加载时自动检查
        window.addEventListener('load', async () => {
            // 检查MCP初始化状态
            try {
                const mcpInit = await import('./src/config/mcp-init.js');
                const initialized = mcpInit.default.isInitialized();
                
                document.getElementById('init-status').className = `test-result ${initialized ? 'success' : 'warning'}`;
                document.getElementById('init-status').innerHTML = 
                    `初始化状态: ${initialized ? '✅ 已初始化' : '⚠️ 未初始化'}`;
                
                // 检查连接状态
                const mcpService = await import('./src/services/mcpService.js');
                const health = await mcpService.default.healthCheck();
                
                document.getElementById('health-status').className = `test-result ${health.healthy ? 'success' : 'warning'}`;
                document.getElementById('health-status').innerHTML = 
                    `健康状态: ${health.healthy ? '✅ 正常' : '⚠️ 异常'} - ${health.message}`;
                
                document.getElementById('connection-status').className = `test-result ${health.healthy ? 'success' : 'warning'}`;
                document.getElementById('connection-status').innerHTML = 
                    `连接状态: ${health.healthy ? '✅ 在线' : '⚠️ 离线'}`;
                    
            } catch (error) {
                document.getElementById('init-status').className = 'test-result error';
                document.getElementById('init-status').innerHTML = `初始化检查失败: ${error.message}`;
            }
        });
    </script>
</body>
</html>